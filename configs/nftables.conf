#!/usr/sbin/nft -f
#
# OpenClaw Host Firewall Configuration
# Deny-all inbound except SSH, allow controlled outbound
#
# Install: sudo cp nftables.conf /etc/nftables.conf
# Enable:  sudo systemctl enable --now nftables
# Reload:  sudo nft -f /etc/nftables.conf
#

# Flush existing rules - DO NOT use 'flush ruleset' as it breaks Docker NAT
flush table inet filter

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow established and related connections
        ct state established,related accept

        # Allow loopback
        iif lo accept

        # Drop invalid packets
        ct state invalid drop

        # ICMP rate limiting (allow ping but prevent flood)
        ip protocol icmp icmp type echo-request limit rate 4/second accept
        ip6 nexthdr icmpv6 icmpv6 type echo-request limit rate 4/second accept

        # Essential ICMPv6 for IPv6 to function
        ip6 nexthdr icmpv6 icmpv6 type { nd-neighbor-solicit, nd-router-advert, nd-neighbor-advert } accept

        # SSH with rate limiting (3 new connections per minute per IP)
        tcp dport 22 ct state new limit rate 3/minute accept

        # HTTP/HTTPS for web services
        tcp dport { 80, 443 } accept

        # OpenClaw gateway (default port 18789)
        tcp dport 18789 accept

        # Log dropped packets (first 5 per minute to avoid log flood)
        limit rate 5/minute log prefix "INPUT DROP: " level info

        # Drop everything else
        drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # Allow Docker container traffic (critical for rootless Docker)
        iifname "docker*" accept
        iifname "br-*" accept
        oifname "docker*" accept
        oifname "br-*" accept

        # Allow established/related for return traffic
        ct state established,related accept
    }

    chain output {
        type filter hook output priority 0; policy accept;

        # Allow loopback
        oif lo accept

        # Allow established/related
        ct state established,related accept

        # DNS (needed for initial resolution)
        udp dport 53 accept
        tcp dport 53 accept

        # HTTP/HTTPS for outbound API calls
        tcp dport { 80, 443 } accept

        # NTP for time sync
        udp dport 123 accept

        # Allow all outbound by default
        accept
    }
}

# Docker NAT table (Docker manages its own rules, this reserves space)
table ip nat {
    chain prerouting {
        type nat hook prerouting priority -100; policy accept;
    }

    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        # Docker will add its masquerade rules here
    }
}
